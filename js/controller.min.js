var bookmarkApp={settings_page:"options.html",ocurl:"",ocusername:"",ocpassword:"",next_check:"",dbobject:"",idb:"",show_list:0,tags:"",connectdb:function(e){"use strict";this.show_list=e,this.idb=indexedDB.open("OCBookmarks",2),this.idb.onupgradeneeded=function(e){var t;bookmarkApp.dbobject=e.target.result,e.oldVersion<1&&(bookmarkApp.dbobject.createObjectStore("bookmarks",{autoIncrement:!0}),t=bookmarkApp.dbobject.createObjectStore("tags",{keyPath:"name"}),bookmarkApp.next_check=0,bookmarkApp.saveCredentials)},this.idb.onsuccess=function(e){bookmarkApp.dbobject=e.target.result,1===bookmarkApp.show_list&&bookmarkApp.PollFromOC()},this.idb.onerror=function(e){console.log("error: ",e)}},clearDB:function(){indexedDB.deleteDatabase("OCBookmarks"),indexedDB.deleteDatabase("IDBBookmarks")},populateStorage:function(){localStorage.setItem("ocurl",""),localStorage.setItem("username",""),localStorage.setItem("password",""),localStorage.setItem("next_check",""),this.loadCredentials()},loadCredentials:function(){this.ocurl=localStorage.getItem("ocurl"),this.ocusername=localStorage.getItem("username"),this.ocpassword=localStorage.getItem("password"),this.next_check=localStorage.getItem("next_check")},saveCredentials:function(){localStorage.setItem("ocurl",this.ocurl),localStorage.setItem("username",this.ocusername),localStorage.setItem("password",this.ocpassword),localStorage.setItem("next_check",this.next_check)},saveBookmarkToCache:function(e,t){"use strict";var o,a,n,r={},c=e;r.url=c.url,r.title=c.title,r.description=c.description,r.tags=c.tags;var s;for(s in r.tags){var l,d,i,m=r.tags[s];l=bookmarkApp.dbobject.transaction(["tags"],"readwrite"),d=l.objectStore("tags"),i=d.put({name:m}),l.oncomplete=function(e){}}o=this.dbobject.transaction(["bookmarks"],"readwrite"),a=o.objectStore("bookmarks"),n=a.put(r,t),o.oncomplete=function(e){console.log(r.title+" "+r.url)}},PollFromOC:function(){if(this.loadCredentials(),this.next_check<Date.now()){document.getElementById("content-wrapper").innerHTML='<div id="loading"><img class="svg" alt="" src="img/loading.gif"></div>';var e=new XMLHttpRequest;e.onreadystatechange=function(){if(4===e.readyState&&200===e.status){var t=JSON.parse(e.responseText);document.getElementById("content-wrapper").innerHTML="";var o;for(o=0;o<t.length;o++)bookmarkApp.saveBookmarkToCache(t[o],o);localStorage.setItem("next_check",Date.now()+36e5),bookmarkApp.displayCache()}},e.open("GET",""+localStorage.getItem("ocurl")+"/index.php/apps/bookmarks/public/rest/v1/bookmark?user="+localStorage.getItem("username")+"&password="+localStorage.getItem("password")+"&select[]=tags&select[]=description",!0),e.send()}else document.getElementById("content-wrapper").innerHTML='<div id="loading"><img class="svg" alt="" src="img/loading.gif"></div>',document.getElementById("loading").className="content-inner-container",bookmarkApp.displayCache()},displayCache:function(){"use strict";bookmarkApp.displayTags();var e,t,o;e=bookmarkApp.dbobject.transaction(["bookmarks"],"readonly").objectStore("bookmarks"),o=e.openCursor(IDBKeyRange.lowerBound(0),"next"),document.getElementById("list").innerHTML="",o.onsuccess=function(){var e,a;if(e=o.result){a=e.value;var n=document.createElement("DIV");n.className="bookmarklet";var r=document.createElement("A"),c=document.createTextNode(a.title),s=document.createElement("P"),l=document.createTextNode(a.description);s.appendChild(l),r.href=a.url,r.target="_blank",r.appendChild(c),n.appendChild(r);var d;for(d in a.tags){var i=a.tags[d];if(t=d,""!==i){var m=document.createElement("SPAN"),p=document.createTextNode(i);m.appendChild(p),m.className="bookmark_tag",m.addEventListener("click",bookmarkApp.search),n.appendChild(m)}}n.appendChild(s),document.getElementById("list").appendChild(n),e["continue"]()}}},displayTags:function(){"use strict";var e,t;e=bookmarkApp.dbobject.transaction(["tags"],"readonly").objectStore("tags"),t=e.openCursor(IDBKeyRange.lowerBound(0),"next"),document.getElementById("content-wrapper").innerHTML="";var o=document.createElement("P"),a=document.createElement("DIV");o.id="tags",o.style="height: 80px;overflow-y:scroll;",a.style="height: 242px;overflow-y:scroll;",a.id="list",t.onsuccess=function(){var e,o,a;if(document.getElementById("tags").className="bookmarklet",e=t.result){o=e.value.name;var n=document.createElement("A");""===o?(a=document.createTextNode("NONE"),n.addEventListener("click",bookmarkApp.displayCache)):(a=document.createTextNode(o),n.addEventListener("click",bookmarkApp.search)),n.appendChild(a),n.className="bookmark_tag",document.getElementById("tags").appendChild(n),e["continue"]()}},document.getElementById("content-wrapper").appendChild(o),document.getElementById("content-wrapper").appendChild(a)},refresh:function(){this.loadCredentials(),this.next_check=0,this.saveCredentials(),this.PollFromOC()},search:function(e){"use strict";bookmarkApp.displayTags(),e.preventDefault();var t,o,a;t=bookmarkApp.dbobject.transaction(["bookmarks"],"readonly").objectStore("bookmarks"),o=t.openCursor(IDBKeyRange.lowerBound(0),"next"),document.getElementById("list").innerHTML="",o.onsuccess=function(t){var n,r,c;if(n=o.result){r=n.value,void 0===e.target.text?(c=e.target.children,a=new RegExp(c[1].value)):a=new RegExp(e.target.text);var s;for(s in r.tags){var l=r.tags[s];if(a.test(l)){var d=document.createElement("DIV");d.className="bookmarklet";var i=document.createElement("A"),m=document.createTextNode(r.title);i.href=r.url,i.target="_blank",i.appendChild(m),d.appendChild(i);var p;for(p in r.tags){var l=r.tags[p];if(""!==l){var u=document.createElement("A"),k=document.createTextNode(l);u.appendChild(k),u.className="bookmark_tag",u.addEventListener("click",bookmarkApp.search),d.appendChild(u)}}var g=document.createElement("P"),b=document.createTextNode(r.description);g.appendChild(b),d.appendChild(g),document.getElementById("list").appendChild(d)}}n["continue"]()}}}};